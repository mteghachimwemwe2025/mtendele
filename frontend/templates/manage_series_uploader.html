<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Manage Sermon Series</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    .sermon-list {
      max-height: 300px;
      overflow-y: auto;
      border: 1px solid #ccc;
      padding: 10px;
      border-radius: 5px;
    }
  </style>
</head>
<body>
<div class="container mt-5">
  <h2>Sermon Series</h2>

  <div class="card mb-4">
    <div class="card-header" id="form-title">Add New Series</div>
    <div class="card-body">
      <form id="seriesForm" enctype="multipart/form-data">
        <input type="hidden" id="seriesId" name="id" />
        <div class="mb-3">
          <label class="form-label">Series Title</label>
          <input type="text" class="form-control" id="title" name="title" required />
        </div>
        <div class="mb-3">
          <label class="form-label">Description</label>
          <textarea class="form-control" id="description" name="description" rows="3"></textarea>
        </div>
        <div class="mb-3">
          <label class="form-label">Upload Image</label>
          <input type="file" class="form-control" id="image" name="image" accept="image/*" />
        </div>
        <div class="mb-3">
          <label class="form-label">Select Sermons to Include</label>
          <div class="sermon-list" id="sermonCheckboxes"></div>
        </div>
        <button type="submit" class="btn btn-primary" id="submitBtn">Add Series</button>
        <button type="button" class="btn btn-secondary" id="cancelEdit" style="display:none;">Cancel</button>
      </form>
    </div>
  </div>

  <div class="card">
    <div class="card-header">All Series</div>
    <div class="card-body">
      <table class="table table-bordered">
        <thead>
          <tr>
            <th>Title</th>
            <th>Sermons</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="seriesList"></tbody>
      </table>
    </div>
  </div>
</div>

<script>
  let editingSeriesId = null;

  async function loadSermons() {
    const res = await fetch('/get_sermons');
    const data = await res.json();
    const container = document.getElementById('sermonCheckboxes');
    container.innerHTML = '';
    data.forEach(s => {
      const div = document.createElement('div');
      div.className = 'form-check';
      div.innerHTML = `
        <input class="form-check-input" type="checkbox" name="sermons" value="${s.id}" id="sermon-${s.id}">
        <label class="form-check-label" for="sermon-${s.id}">${s.title} (${s.date})</label>
      `;
      container.appendChild(div);
    });
  }

  async function loadSeries() {
    const res = await fetch('/get_series');
    const data = await res.json();
    const tbody = document.getElementById('seriesList');
    tbody.innerHTML = '';
    data.forEach(series => {
      const sermonTitles = series.sermons && series.sermons.length
        ? series.sermons.map(s => `â€¢ ${s.title}`).join('<br>')
        : 'No sermons yet';
      tbody.innerHTML += `
        <tr>
          <td>${series.title}</td>
          <td>
            ${series.sermons.length} sermon(s)<br>
            <small>${sermonTitles}</small>
          </td>
          <td>
            <button class="btn btn-warning btn-sm" onclick='editSeries(${JSON.stringify(series)})'>Edit</button>
            <button class="btn btn-danger btn-sm" onclick='deleteSeries(${series.id})'>Delete</button>
          </td>
        </tr>
      `;
    });
  }

  function editSeries(series) {
    editingSeriesId = series.id;
    document.getElementById('form-title').innerText = "Edit Series";
    document.getElementById('submitBtn').innerText = "Update Series";
    document.getElementById('cancelEdit').style.display = "inline-block";

    document.getElementById('seriesId').value = series.id;
    document.getElementById('title').value = series.title;
    document.getElementById('description').value = series.description || '';

    // Reset all sermon checkboxes and check those in series
    document.querySelectorAll('#sermonCheckboxes input[type=checkbox]').forEach(cb => {
      cb.checked = false;
    });
    if (series.sermons) {
      series.sermons.forEach(s => {
        const cb = document.getElementById('sermon-' + s.id);
        if (cb) cb.checked = true;
      });
    }
  }

  async function deleteSeries(id) {
    if (!confirm("Are you sure you want to delete this series?")) return;
    const res = await fetch('/delete_series', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({ id })
    });
    await res.json();
    await loadSeries();
  }

  document.getElementById('seriesForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const form = e.target;
    const formData = new FormData(form);

    // Collect selected sermon ids manually
    const selectedSermons = Array.from(document.querySelectorAll('input[name="sermons"]:checked')).map(cb => cb.value);
    // Remove old sermons key (if any) and append new one correctly as JSON string
    if (formData.has('sermons')) formData.delete('sermons');
    formData.append('sermons', JSON.stringify(selectedSermons));

    const url = editingSeriesId ? '/update_series' : '/add_series';

    const res = await fetch(url, {
      method: 'POST',
      body: formData
    });
    const result = await res.json();

    if (result.status === 'success' || result.status === 'updated') {
      alert('Series saved successfully!');
      form.reset();
      editingSeriesId = null;
      document.getElementById('form-title').innerText = "Add New Series";
      document.getElementById('submitBtn').innerText = "Add Series";
      document.getElementById('cancelEdit').style.display = "none";
      await loadSeries();
      await loadSermons();
    } else {
      alert('Error: ' + (result.message || 'Unknown error'));
    }
  });

  document.getElementById('cancelEdit').addEventListener('click', function () {
    editingSeriesId = null;
    document.getElementById('seriesForm').reset();
    document.getElementById('form-title').innerText = "Add New Series";
    document.getElementById('submitBtn').innerText = "Add Series";
    this.style.display = "none";
  });

  // Initial load
  (async () => {
    await loadSermons();
    await loadSeries();
  })();
</script>
</body>
</html>
