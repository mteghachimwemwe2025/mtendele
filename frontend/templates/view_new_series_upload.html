<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Sermon Series Viewer</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f0f2f5;
      margin: 0;
      padding: 20px;
    }

    .series-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
      max-width: 300px;
      margin-bottom: 30px;
    }

    .series-item {
      background: #fff;
      border-radius: 10px;
      padding: 12px 16px;
      cursor: pointer;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      transition: background 0.2s;
    }

    .series-item:hover {
      background: #f3f3f3;
    }

    .series-details {
      margin-bottom: 30px;
    }

    .series-details img {
      max-width: 100%;
      height: auto;
      border-radius: 10px;
      margin-top: 10px;
    }

    .sermon {
      background: #fff;
      padding: 15px;
      margin-bottom: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .media-container {
      margin-top: 10px;
    }

    iframe, video {
      max-width: 100%;
      height: 300px;
      border-radius: 10px;
    }
  </style>
</head>
<body>
  <h1>Sermon Series</h1>

  <div class="series-list" id="seriesList"></div>

  <div class="series-details" id="seriesDetails"></div>

  <div class="sermons" id="sermonsContainer"></div>

  <script>
    async function fetchSeriesList() {
      const response = await fetch('/view_new_series');
      const data = await response.json();
      const seriesList = document.getElementById('seriesList');
      seriesList.innerHTML = '';
      data.series_list.forEach(series => {
        const item = document.createElement('div');
        item.className = 'series-item';
        item.textContent = series.title;
        item.onclick = () => loadSeries(series.id);
        seriesList.appendChild(item);
      });
    }

    async function loadSeries(seriesId) {
      const response = await fetch(`/view_new_series?series_id=${seriesId}`);
      const data = await response.json();
      const detailsContainer = document.getElementById('seriesDetails');
      const sermonsContainer = document.getElementById('sermonsContainer');

      // Display Series Info
      detailsContainer.innerHTML = `
        <h2>${data.series.title}</h2>
        <p>${data.series.description || ''}</p>
        ${data.series.image ? `<img src="${data.series.image}" alt="Series Image">` : ''}
      `;

      // Display Sermons
      sermonsContainer.innerHTML = '';
      data.sermons.forEach(sermon => {
        const div = document.createElement('div');
        div.className = 'sermon';
        div.innerHTML = `
          <h3>${sermon.title}</h3>
          <p><strong>Speaker:</strong> ${sermon.speaker || 'N/A'}</p>
          <p><strong>Date:</strong> ${sermon.date || 'N/A'}</p>
          <p><strong>Scripture:</strong> ${sermon.scripture || 'N/A'}</p>
          <p>${sermon.description || ''}</p>
          <div class="media-container">
            ${!sermon.youtube_url || sermon.youtube_url === 'N/A' ? getMediaPlayerHTML(sermon.media) : ''}
            ${getYouTubeEmbedHTML(sermon.youtube_url)}
          </div>
          ${sermon.notes ? `<a href="${sermon.notes}" target="_blank">Download Notes</a>` : ''}
        `;
        sermonsContainer.appendChild(div);
      });
    }

    function getYouTubeEmbedHTML(url) {
      if (!url || url === 'N/A') return '';
      const videoId = extractYouTubeID(url);
      if (!videoId) return '';
      return `<iframe src="https://www.youtube.com/embed/${videoId}" frameborder="0" allowfullscreen></iframe>`;
    }

    function getMediaPlayerHTML(media) {
      if (!media) return '';
      const ext = media.split('.').pop().toLowerCase();
      if (['mp4', 'webm', 'ogg'].includes(ext)) {
        return `<video controls src="${media}"></video>`;
      } else if (['mp3', 'wav'].includes(ext)) {
        return `<audio controls src="${media}"></audio>`;
      }
      return '';
    }

    function extractYouTubeID(url) {
      const regex = /(?:https?:\/\/)?(?:www\.)?(?:youtube\.com\/(?:watch\?v=|embed\/)|youtu\.be\/)([^\s&]+)/;
      const match = url.match(regex);
      return match ? match[1] : null;
    }

    // Initial load
    fetchSeriesList();
  </script>
</body>
</html>
