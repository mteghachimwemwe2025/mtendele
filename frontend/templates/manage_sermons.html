<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Manage Sermons</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
</head>
<body>
<div class="container mt-5">
  <h2>Manage Sermons</h2>

  <!-- Add/Edit Form -->
  <div class="card my-4">
    <div class="card-header" id="form-title">Add New Sermon</div>
    <div class="card-body">
      <form id="sermonForm" enctype="multipart/form-data">
        <input type="hidden" id="sermonId" name="id" />
        <div class="mb-3">
          <label class="form-label">Title</label>
          <input type="text" class="form-control" id="title" name="title" required />
        </div>
        <div class="row mb-3">
          <div class="col-md-6">
            <label class="form-label">Speaker</label>
            <input type="text" class="form-control" id="speaker" name="speaker" required />
          </div>
          <div class="col-md-6">
            <label class="form-label">Date</label>
            <input type="date" class="form-control" id="date" name="date" required />
          </div>
        </div>
        <div class="mb-3">
          <label class="form-label">Scripture Reference</label>
          <input type="text" class="form-control" id="scripture" name="scripture" />
        </div>
        <div class="mb-3">
          <label class="form-label">Description</label>
          <textarea class="form-control" id="description" name="description" rows="3"></textarea>
        </div>
        <div class="row mb-3">
          <div class="col-md-6">
            <label class="form-label">Media (Audio or Video)</label>
            <input type="file" class="form-control" id="media" name="media" accept="audio/*,video/*" />
          </div>
          <div class="col-md-6">
            <label class="form-label">Notes URL</label>
            <div class="input-group">
              <input type="text" class="form-control" id="notes" name="notes" />
              <button type="button" class="btn btn-outline-secondary" onclick="selectFromStorage('notes')">üìÅ</button>
            </div>
          </div>
        </div>
        <div class="mb-3">
          <label class="form-label">Image URL</label>
          <div class="input-group">
            <input type="text" class="form-control" id="image" name="image" />
            <button type="button" class="btn btn-outline-secondary" onclick="selectFromStorage('image')">üìÅ</button>
          </div>
        </div>
        <button type="submit" class="btn btn-primary" id="submitBtn">Add Sermon</button>
        <button type="button" class="btn btn-secondary" id="cancelEdit" style="display: none;">Cancel</button>
      </form>
    </div>
  </div>

  <!-- Sermons Table -->
  <div class="card">
    <div class="card-header">All Sermons</div>
    <div class="card-body">
      <table class="table table-striped" id="sermonTable">
        <thead>
          <tr>
            <th>Title</th>
            <th>Speaker</th>
            <th>Date</th>
            <th>YouTube</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="sermonList">
          <!-- Sermons will load here -->
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- Hidden input for simulated file picking -->
<input type="file" id="storagePicker" style="display:none;" onchange="handleStoragePick()" />

<script>
  let editingId = null;
  let currentTargetInput = null;

  function loadSermons() {
    fetch('/get_sermons')
      .then(response => response.json())
      .then(data => {
        const list = document.getElementById('sermonList');
        list.innerHTML = '';
        data.forEach(sermon => {
          const ytLink = sermon.youtube_url && sermon.youtube_url !== "N/A"
            ? `<a href="${sermon.youtube_url}" target="_blank">‚ñ∂ Watch</a>`
            : '‚Äî';
          list.innerHTML += `
            <tr>
              <td>${sermon.title}</td>
              <td>${sermon.speaker}</td>
              <td>${sermon.date}</td>
              <td>${ytLink}</td>
              <td>
                <button class="btn btn-sm btn-warning" onclick='editSermon(${JSON.stringify(sermon)})'>Edit</button>
                <button class="btn btn-sm btn-danger" onclick="deleteSermon(${sermon.id})">Delete</button>
                <button class="btn btn-sm btn-info" onclick="uploadToYouTube(${sermon.id})">üì§ YouTube</button>
              </td>
            </tr>
          `;
        });
      })
      .catch(err => alert("Failed to load sermons.\n\n" + err));
  }

  function uploadToYouTube(sermonId) {
    if (!sermonId) return alert("No sermon selected.");
    if (confirm("Are you sure you want to upload this video to YouTube?")) {
      window.location.href = `/authorize_youtube/${sermonId}`;
    }
  }

  function editSermon(sermon) {
    editingId = sermon.id;
    document.getElementById('form-title').innerText = "Edit Sermon";
    document.getElementById('submitBtn').innerText = "Update Sermon";
    document.getElementById('cancelEdit').style.display = "inline-block";

    document.getElementById('sermonId').value = sermon.id;
    document.getElementById('title').value = sermon.title;
    document.getElementById('speaker').value = sermon.speaker;
    document.getElementById('date').value = sermon.date;
    document.getElementById('scripture').value = sermon.scripture;
    document.getElementById('description').value = sermon.description;
    document.getElementById('media').value = '';
    document.getElementById('notes').value = sermon.notes;
    document.getElementById('image').value = sermon.image;
  }

  function deleteSermon(id) {
    if (confirm("Are you sure?")) {
      fetch('/delete_sermon', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ id })
      })
      .then(() => loadSermons())
      .catch(err => alert("Delete failed:\n\n" + err));
    }
  }

  document.getElementById('sermonForm').addEventListener('submit', function(e) {
    e.preventDefault();

    const formElement = this;
    const formData = new FormData(formElement);
    if (!editingId) formData.delete('id');

    const url = editingId ? '/update_sermon' : '/add_sermon';

    fetch(url, {
      method: 'POST',
      body: formData
    })
    .then(res => res.json())
    .then(data => {
      if (data.status === "success") {
        loadSermons();
        formElement.reset();
        editingId = null;
        document.getElementById('form-title').innerText = "Add New Sermon";
        document.getElementById('submitBtn').innerText = "Add Sermon";
        document.getElementById('cancelEdit').style.display = "none";
      } else {
        alert('Error:\n\n' + data.message);
      }
    })
    .catch(err => alert('Request failed:\n\n' + err));
  });

  document.getElementById('cancelEdit').addEventListener('click', function () {
    editingId = null;
    document.getElementById('sermonForm').reset();
    document.getElementById('form-title').innerText = "Add New Sermon";
    document.getElementById('submitBtn').innerText = "Add Sermon";
    this.style.display = "none";
  });

  function selectFromStorage(fieldId) {
    currentTargetInput = document.getElementById(fieldId);
    document.getElementById('storagePicker').click();
  }

  function handleStoragePick() {
    const fileInput = document.getElementById('storagePicker');
    const file = fileInput.files[0];
    if (file && currentTargetInput) {
      currentTargetInput.value = `storage/${file.name}`;
      currentTargetInput = null;
      fileInput.value = '';
    }
  }

  loadSermons();
</script>
</body>
</html>
