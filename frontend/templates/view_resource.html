<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Resources by Category</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
<div class="container mt-5">
  <h2 class="text-center mb-4">Resources by Category</h2>
  
  <div class="mb-3">
    <label for="categorySelect" class="form-label">Select Category:</label>
    <select class="form-select" id="categorySelect" onchange="loadResources()">
      <option value="">-- Choose a Category --</option>
    </select>
  </div>

  <div id="resourceTableContainer" class="mt-4 text-center">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
  </div>
</div>

<script>
function loadCategories() {
  fetch('/get_categories')
    .then(res => res.json())
    .then(categories => {
      const select = document.getElementById('categorySelect');
      categories.forEach(cat => {
        const option = document.createElement('option');
        option.value = cat.id;
        option.textContent = cat.name;
        select.appendChild(option);
      });
    });
}

function loadResources() {
  const categoryId = document.getElementById('categorySelect').value;
  const container = document.getElementById('resourceTableContainer');

  if (!categoryId) {
    container.innerHTML = '<div class="alert alert-info">Please select a category.</div>';
    return;
  }

  container.innerHTML = `
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
  `;

  fetch(`/get_resources_by_category?category_id=${categoryId}`)
    .then(res => res.json())
    .then(resources => {
      if (!resources.length) {
        container.innerHTML = '<div class="alert alert-warning">No resources found for this category.</div>';
        return;
      }

      let html = `<div class="table-responsive">
        <table class="table table-bordered">
          <thead><tr><th>Title</th><th>Description</th><th>Date</th><th>Download</th></tr></thead>
          <tbody>`;

      resources.forEach(r => {
        html += `<tr>
          <td>${r.title}</td>
          <td>${r.description}</td>
          <td>${r.date || 'N/A'}</td>
          <td>
            ${r.file ? `<a href="${r.file}" class="btn btn-sm btn-primary" download>Download</a>` : 'N/A'}
          </td>
        </tr>`;
      });

      html += '</tbody></table></div>';
      container.innerHTML = html;
    })
    .catch(err => {
      container.innerHTML = `<div class="alert alert-danger">Error: ${err.message}</div>`;
    });
}

function loadDefaultRecentResources() {
  const container = document.getElementById('resourceTableContainer');
  container.innerHTML = `
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
  `;

  fetch('/get_recent_resources')
    .then(res => res.json())
    .then(resources => {
      if (!resources.length) {
        container.innerHTML = '<div class="alert alert-warning">No recent resources found.</div>';
        return;
      }

      let html = `<h5 class="mb-3">Recent Resources</h5>
        <div class="table-responsive">
        <table class="table table-bordered">
          <thead><tr><th>Title</th><th>Description</th><th>Date</th><th>Download</th></tr></thead>
          <tbody>`;

      resources.forEach(r => {
        html += `<tr>
          <td>${r.title}</td>
          <td>${r.description}</td>
          <td>${r.date || 'N/A'}</td>
          <td>
            ${r.file ? `<a href="${r.file}" class="btn btn-sm btn-primary" download>Download</a>` : 'N/A'}
          </td>
        </tr>`;
      });

      html += '</tbody></table></div>';
      container.innerHTML = html;
    })
    .catch(err => {
      container.innerHTML = `<div class="alert alert-danger">Error loading recent resources: ${err.message}</div>`;
    });
}

document.addEventListener('DOMContentLoaded', () => {
  loadCategories();
  loadDefaultRecentResources();
});
</script>
</body>
</html>
